## Exercise 1: Proof of concept deployment

Duration: 60 minutes

Contoso has asked you for a proof of concept in Microsoft Azure by deploying the web, database, and API applications for the solution as well as validating that the core functionality of the solution works. Ensure all resources use the same resource group previously created for the App Service Environment.

### Task 1: Deploy the e-commerce website, SQL Database, and storage

In this exercise, you will provision a website via the Azure **Web App + SQL** template using the Microsoft Azure Portal. You will then edit the necessary configuration files in the starter project and deploy the e-commerce website.

<!-- omit in toc -->
#### Subtask 1: Configure SQL Database Firewall and Retrieve Connection String

1. Navigate to the Azure Management portal, [http://portal.azure.com](http://portal.azure.com/), using a new tab or instance and login with your lab-provided Azure credentials.

2. Navigate to the **contososports** resource group.

3. Select the **ContosoSportsDB** SQL Database.

    ![The contososports Resource Group blade with the "ContosoSportsDB" highlighted.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image22.png "Azure Portal")

4. On the **SQL Database** blade, select the **Show database connection strings** link.

    ![On the SQL Database blade, in the left pane, Overview is selected. In the right pane, under Essentials, the Connection strings (Show database connection strings) link is circled.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image23.png "SQL Database blade")

5. On the **Database connection strings** blade, select and copy the **ADO.NET** connection string. Then, save it in **Notepad** for use later, being sure to replace the password placeholder with **demo@pass123**

    ![In the Database connection strings blade, the ADO.NET connection string is circled.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image24.png "Database connection strings blade")

6. Go back to the **contososports** resource group blade, and select the **contososports** SQL Server.

    ![The contososports resource group with the contososports sql server highlighted.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/2019-11-15-17-47-46.png "Azure Portal")

7. On the **Overview** screen of the **SQL Server** blade, select the **Show firewall settings**.

    ![On the SQL Server Overview screen with the Show firewall settings link highlighted.](media/2019-03-31-14-37-31.png "SQL Server Overview")

8. On the **Firewall Settings** blade, specify a new rule named **My IP**, copy your **Client IP address**, and paste it into the **Start IP** and **End IP**. This will set the allowed IP Address range to just your IP address so you can connect to the database from this machine.

    ![Screenshot of the Rule name, Start IP. and End IP fields on the Firewall Settings blade.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image27.png "Firewall Settings blade")

9. Select **Save**.

    ![Screenshot of the Firewall settings Save button.](media/2019-04-10-16-00-29.png "Firewall settings Save button")

10. Update progress can be found by selecting the **Notifications** link located at the top of the page.

    ![Screenshot of the Success dialog box, which says that the server firewall rules have been successfully updated.](media/2019-04-19-13-39-41.png "Success dialog box")

11. Close all configuration blades.

<!-- omit in toc -->
#### Subtask 2: Retrieve Storage Account Access Keys

1. Go back to the **contososports** blade resource group, and select the **contoso** Storage account.

2. On the **Storage account** blade, scroll down, and, under the **SETTINGS** menu area, select the **Access keys** option.

    ![In the Storage account blade, under Settings, Access keys is circled.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image35.png "Storage account blade")

3. On the **Access keys** blade, select the copy button by the **Connection String** field in the **key1** section. Paste the value into **Notepad** for later usage. 

    ![In the Access keys blade default keys section, the copy button for the key1 connection string is circled.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image36.png "Access keys blade, default keys section")

<!-- omit in toc -->
#### Subtask 3: Retrieve Service Bus Queue Connection String

1. Go back to the **contososports** blade resource group, and select the **contoso** Service Bus Namespace.

    ![Service Bus Namespace resource is highlighted](media/2020-03-18-10-38-09.png "Service Bus Namespace")

2. Select the **Queues** link under Entities.

    ![Queues link under Entities](media/2020-03-18-10-38-57.png "Queues link")

3. On the **Queues** pane, select the **receiptgenerator** Service Bus Queue.

    ![receiptgenerator queue is highlighted](media/2020-03-18-10-40-40.png "receiptgenerator queue is highlighted")

4. On the **receiptgenerator** Service Bus Queue blade, select the **Shared access policies** link under Settings.

    ![Shared access policies link is shown](media/2020-03-18-10-42-03.png "Shared access policies link is shown")

5. Select the **Publisher** shared access policy.

    ![Publisher policy is highlighted](media/2020-03-18-10-43-12.png "Publisher policy is highlighted")

    >**Note**: The _Publisher_ and _Listener_ shared access policies for the Azure Service Bus Queue were deployed as part of the ARM Template that was used to setup the lab environment. As you can see, the **Publisher** policy that we're copying the connection string for, only has permissions to _Send_ messages to the queue.
    >
    > By default, no policies are created. Additionally, it is best practice to use least privilege security to create separate shared access policies for publishers sending messages and listeners receiving messages from the queue. 

6. On the **SAS Policy** pane, copy the **Primary Connection String**. Paste the value into **Notepad** for later usage. 

    ![Primary Connection String is highlighted](media/2020-03-18-10-54-39.png "Primary Connection String is highlighted")

<!-- omit in toc -->
#### Subtask 4: Create secrets in Azure Key Vault

You've retrieved multiple access keys and connection strings in this task. To properly secure them, and to keep these values out of application code, we need a secure place to store them. This place is the Azure Key Vault.

1. Go back to the **contososports** resource group blade, and select the **contosokv** Key Vault resource.

    ![The resource listing is displayed with the key vault item selected.](media/rg_selectkeyvault.png)

2. Beneath **Settings**, select **Access Policies**.

3. In order to add, edit, or view secrets, you must be granted access through a new Access policy. Select the **+ Add Access Policy** link.
    
    ![A portion of the Access Policies screen is shown with the + Add Access Policy link selected.](media/add_access_policy_link.png)

4. Expand the **Secret permissions** drop down, and check the **Select all** checkbox.

5. For **Select principal**, select your Azure user account, and select **Add**.

    ![The Add access policy form is displayed with the Secret Permissions and Select principal fields highlighted.](media/kv_add_access_policy_form.png)

6. Press **Save** on the **Access policies** screen to save the changes.

7. Beneath **Settings**, select **Secrets** then **Generate/Import**.

8. Create the following secret values by filling out **Name** and **Value** (retaining the defaults for all other fields):

    | Name | Value |
    |------|-------|
    | AzureQueueConnectionString | {the primary connection string you recorded for the queue} |
    | ContosoSportsLeague | {the database connection string} |
    | contososportsstorage | {the primary connection string you recorded for the storage account} |

    ![The Create a secret form is displayed with the Name and Value fields highlighted.](media/kv_createasecret.png)

<!-- omit in toc -->
#### Subtask 5: Centralize secrets for multiple projects using an App Configuration store

The Contoso Sports solution contains multiple projects, each of which access the same Azure resources. In this subtask, we will be centralizing the configuration of the solution applications via the deployed Azure **App Configuration** resource.

1. Go back to the **contososports** resource group blade, and select the **contosoconfig** App Configuration resource.

    ![The resource listing is displayed with the App Configuration resource highlighted.](media/appconfig_resourcelist_selection.png)

2. Select **Configuration explorer** found beneath the **Operations** section of the left menu.

3. On the **Configuration explorer** screen, expand **+ Create** and select **Key Vault reference**.
   
   ![The + Create button is expanded with the Key Vault reference item highlighted.](media/ac_createkeyvaultreference_menu.png)

4. On the **Create** form, be sure to select the appropriate **Subscription**, **Resource group**, and the **contosokv** Key Vault. Create the following Key Vault references:

    | Key | Secret | Secret version |
    |-----|--------|----------------|
    | ConnectionStrings:ReceiptQueue | Select **AzureQueueConnectionString** | Select **Latest version** |
    | ConnectionStrings:ReceiptStorage | Select **contososportsstorage** | Select **Latest version** |
    | ConnectionStrings:SportsDB | Select **ContosoSportsLeague** | Select **Latest version** |

    ![The Create new Key vault reference form is displayed populated with the ConnectionStrings:ReceiptQueue values.](media/ac_createkeyvaultref_form.png)

5. From the left menu, select **Access keys** located in the **Settings** section.

6. Select the **Read-only keys** tab. 

7. Copy the **Primary key Connection string** value, and paste it into notepad. This value is needed to connect the deployed applications to the App Configuration store. 
    
    ![A portion of the Access keys screen is displayed. The Read-only keys tab is highlighted and the copy button next to the Primary key Connection string textbox is selected.](media/ac_connectionstringcopy.png)

<!-- omit in toc -->
#### Subtask 6: Update the configuration in the starter project

1. Go back to the **contososports** resource group blade.

2. Select the **contosoapp** web app (**App Service** type).

    ![Resources listed for ContosoSports. Web app selected.](media/2019-04-19-13-46-40.png "Resources listed for ContosoSports")

3. Copy the web app URL to Notepad.

    - Select the **Overview** link.
    - Copy the URL to Notepad for later use. Use the **Copy to clipboard** link.

    ![In the Web App Overview settings, the URL has a box around the link.](media/2019-03-22-16-33-05.png "Contoso Web App Overview")

4. On the **App Service** blade, scroll down in the left pane. Under the **Settings** menu, select **Configuration**.

    ![In the App Service blade, under Settings, select Configuration link.](media/2019-04-19-16-38-54.png "Configuration link")

5. Locate **Connection Strings** section below **Application Settings**.

    ![The App Service Configuration screen is displayed with the Connection Strings section title and + New connection string button highlighted.](media/image41.png "Connection Strings section")

6. Add a new **Connection String** with the following values, and select **OK**:

   - Name: **AppConfig**

   - Value: **Enter the Connection String for the App Configuration Store**.

   - Type: Select **Custom**.

    ![The Add/Edit connection string form is displayed and is populated with the preceding values.](media/image43.png)

7. Select **Save** to commit the changes.

8. The e-commerce website application resource needs access to the Key Vault. The App Configuration will use pass-through authentication to the Key Vault. To authenticate the application, it will utilize a system managed identity. From the left menu, select **Identity**.

9. With the **System assigned** tab selected, toggle the **Status** field to **On**, then select **Save**. 

    ![On the Identity screen, the System assigned tab is selected and the Status field is in the On position.](media/appconfig_systemidentity.png)

10. Open the **contosokv** Key Vault resource, and from the left menu, select **Access policies**. 

11. Select the **+ Add Access Policy** link.

12. In the **Add access policy** form, expand **Secret permissions** and check the box next to **Get** and **List**.  

13. In the **Select principal** blade, search for **contosoapp** and choose the managed identity that was just created.

14. Select **Add**.
    
    ![The Add access policy form is displayed with the Get secret permission selected, and the contosoconfig principal selected.](media/kv_addaccesspolicy_forconfig.png)

15. Select **Save** on the Access policies screen to commit the changes. 

<!-- omit in toc -->
#### Subtask 7: Configure and deploy the e-commerce Web App from Visual Studio

1. Navigate to the **Contoso.Apps.SportsLeague.Web** project located in the **Web** folder using the **Solution Explorer** of Visual Studio.

2. Right-click the **Contoso.Apps.SportsLeague.Web** project, and select **Edit Project File**.

    ![In the solution explorer, the Contoso.Apps.SportsLeague.Web project is highlighted with its context menu expanded. The Edit Project File option is selected from the menu.](media/web_editprojfile_menu.png)

3. In the **PropertyGroup** element, add the following XML beneath the TargetFramework item and save the file:
   
    ```xml
    <UserSecretsId>79a3edd0-2092-40a2-a04d-dcb46d5ca9ed</UserSecretsId>
    ```

    ![A portion of the project file is displayed. The UserSecretsId element is highlighted in the code listing.](media/web_addusersecretsidtoproject.png)

4. Right-click the **Contoso.Apps.SportsLeague.Web** project, and select **Manage NuGet Packages**.

5. Select the **Browse** tab, and search for **Microsoft.Azure.AppConfiguration.AspNetCore**.

6. Select **Microsoft.Azure.AppConfiguration.AspNetCore** from the search results, and in the next pane, select **Install** to install the latest stable version.

    ![The Nuget Package Manager windows is displayed with the Browse tab selected, Microsoft.Azure.AppConfiguration.AspNetCore entered into the search box and selected from the search results. In the next pane, the Install button is selected.](media/nuget_installappconfigpackage_web.png)

7. Repeat step 4-6, this time installing the latest **Azure.Identity**.

8. Now we are ready to configure this application to use the App Configuration in Azure. Under the **Contoso.Apps.SportsLeague.Web** project, open the **Program.cs** file.

9. Uncomment the following **using** statements at the top of the file:
    
    ```C#
    using Microsoft.Extensions.Configuration;
    using Azure.Identity;
    ```

10. In the **CreateHostBuilder** method, uncomment the following code - this tells the application to utilize the AppConfig connection string that you've already setup on the **contosoapp** application service to point to the centralized App Configuration resource.
    
    ```C#
    webBuilder.ConfigureAppConfiguration((hostingContext, config) =>
    {
        var settings = config.Build();

        config.AddAzureAppConfiguration(options =>
        {
            options.Connect(settings["ConnectionStrings:AppConfig"])
                    .ConfigureKeyVault(kv =>
                    {
                        kv.SetCredential(new DefaultAzureCredential());
                    });
        });
    })
    .UseStartup<Startup>();
    ```
11. Right-click the **Contoso.Apps.SportsLeague.Web** project, and select **Publish**.

    ![In Solution Explorer, under Solution \'Contoso.Apps.SportsLeague\' (7 projects), Web is expanded, and under Web, Contoso.Apps.SportsLeague.Web is selected.](media/2019-04-19-14-03-04.png "Solution Explorer")

12. On the Publish dialog, select **Start** in the **Publish** section.

13. On the **Pick a publish target** dialog, ensure **App Service** is selected, and in the right pane, ensure the **Select Existing** option is selected, then choose **Create Profile**.

    ![The Pick a publish target dialog is displayed with App Service and Select existing selected.](media/pickpublishtargetappserviceexisting.png)

14. In the App Service dialog, expand the resource group, and select the **contosoapp** from the list, then choose **OK**.
    
    ![The App Service dialog is shown with the resource group expanded and the contosoapp application service selected in the list. The OK button is highlighted.](media/deploywebapp_serviceselection.png)

15. Select **Publish** to publish the Web application.

    ![Publish profile is displayed with the Publish button highlighted.](media/2020-06-15-16-53-15.png "Publish profile")

16. In the Visual Studio **Output** view, you will see a status that indicates the Web App was published successfully.

    ![Screenshot of the Visual Studio Output view, with the Publish Succeeded message circled.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image50.png "Visual Studio Output view")

    >**Note**: Your URL will differ from the one shown in the Output screenshot because it must be globally unique.

17. A new browser should automatically open the new web applications. Validate the website by choosing the **Store** link on the menu. You should see product items. If products are returned, then the connection to the database is successful.

    ![Screenshot of the Store link.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image51.png "Store link")

    >**Troubleshooting**: If the web site fails to start up or show products, go back and double check all your connection string entries and passwords web application settings.

### Task 2: Setup SQL Database Geo-Replication

In this exercise, the attendee will provision a secondary SQL Database and configure Geo-Replication using the Microsoft Azure Portal.

<!-- omit in toc -->
#### Subtask 1: Add secondary database

1. In the Azure Portal, navigate back to the lab resource group.

2. From the list of resources, select the **ContosoSportsDB** SQL database resource.

    ![The resource listing is displayed with the ContosoSportsDB SQL database resource highlighted.](media/resourcelist_contososportsdb.png)

3. Under the **Settings** menu area, select **Geo-Replication**.

    ![In the Settings section, Geo-Replication is selected.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image53.png "Settings section")

4. Select the Azure Region to place the Secondary within.

    ![The Geo-Replication pane with list of locations. Primary location is set to West US.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image54.png "Geo-Replication blade")

    The Secondary Azure Region should be the Region Pair for the region the SQL Database is hosted in. Consult <https://docs.microsoft.com/en-us/azure/best-practices-availability-paired-regions> to see which region pair the location you are using for this lab is in.

    >**Note**: If you choose a region that cannot be used as a secondary region, you will not be able to pick a pricing plan. Choose another region.
    > 
    > ![Wrong geo-replication region selected. Not available options presented.](media/2019-03-30-16-05-25.png "Not available options presented.")

5. On the **Create secondary** blade, select **Secondary Type** as **Readable**.

6. Select **Target server** ***Configure required settings***.

    ![the Target server Configure required settings option is selected.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image55.png "Target server option")

7. On the **New server** blade, specify the following configuration:

   - Server name: **A unique value (ensure the green checkmark appears)**.

   - Server admin login: **demouser**

   - Password and Confirm Password: **demo@pass123**

    ![The fields in the New Server blade display with the previously defined settings.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image56.png "New Server blade")

8. Once the values are accepted in the **New server** blade, choose **Select**.

    ![Screenshot of the Select button.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image20.png "Select button")

9. On the **Create secondary** blade, select **OK**.

    ![Screenshot of the OK button.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image57.png "OK button")

    > **Note**: The Geo-Replication will take a few minutes to complete.

10. After the Geo-Replication has finished provisioning, return to the resource group for the lab.

11. Select the name of the secondary SQL Server resource that you just created.

    ![In the list of resources, the secondary SQL server resource is selected.](media/secondarydatabaseinresourcelist.png)

12. On the **SQL Server** blade, within the **Overview** pane, select **Show firewall settings** link.

    ![On the SQL Server blade, at the top, the Set server firewall tile is boxed in red.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image62.png "SQL Server blade, Essentials section")

13. On the **Firewall Settings** blade, specify a new rule named **My IP**, copy your **Client IP address**, and paste it into the **Start IP** and **End IP**. This will set the allowed IP Address range to just your IP address so you can connect to the database from this machine.

    ![On the Firewall Settings blade, in the New rule section, a new rule has been created with the previously defined settings.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image27.png "New rule section ")

14. Select **Save**.

    ![Screenshot of the Firewall settings Save button.](media/2019-04-10-16-00-29.png "Firewall settings Save button")

15. Update progress can be found by choosing the **Notifications** link located at the top of the page.

    ![Screenshot of the Success dialog box, which says that the server firewall rules have been successfully updated.](media/2019-04-19-13-39-41.png "Success dialog box")

16. Close all configuration blades.

<!-- omit in toc -->
#### Subtask 2: Setup SQL Failover Group

With SQL Database Geo-Replication configured, the Azure SQL Failover Groups feature can be used to enable "auto failover" scenarios for the SQL Database. This enables a single connection string endpoint to be used by the application, and SQL Database will automatically handle failing over from Primary to Secondary database in the event of a SQL Database outage / down time.

1. In the Azure Portal, navigate back to the lab resource group.

2. From the list of resources, select the Primary SQL server resource.
    
    ![The list of lab resources is shown with the primary SQL server resource selected.](media/primary_sqlserverresource_inlist.png)

3. On the **SQL server** blade, select **Failover groups** under **Settings**.

    ![Failover groups setting option.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/sqlserverfailovergroupslink.png "Failover groups setting option")

4. On the **Failover groups** pane, select the **Add group** button.

    ![Add group button.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/failovergroupsaddgroupbutton.png "Add group buton")

5. On the **Failover group** pane, enter a unique **Failover group name**.

    ![Failover group name field.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/sqlfailovergroupname.png "Failover group name field")

6. Select **Secondary server**, then choose the **Secondary SQL Database** that was previously created.

    ![Secondary SQL Database is highlighted.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/sqlfailoversecondaryserver.png "Secondary SQL Database is highlighted")

7. Select **Database within the group**, then choose the **ContosoSportsDB** database, then **Select**.

    ![Steps to choose the ContosoSportsDB are highlighted.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/sqlfailoversecondarydatabase.png "Steps to choose the ContosoSportsDB are highlighted")

8. Select **Create** to create the SQL Failover Group.

9.  Once the Failover Group has been created, select it in the list.

    ![Failover Group is highlighted.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/sqlfailovergrouplist.png "Failover Group is highlighted")

10. Notice, on the **Failover group** pane, the map and display showing the _Primary_ and _Secondary_ SQL Database servers within the failover group. The _Primary_ database shows as **Automatic** failover for Read/Write of data, while the _Secondary_ database doesn't since it is currently Read only.

    ![Map display of Primary and Seconary databases.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/sqlfailovergroupmap.png "Map display of Primary and Seconary databases")

11. Scroll down, below the map, to where the **Read/write listener endpoint** and **Read-only listener endpoint** are displayed. These allow for applications to be configured to connect to the SQL Failover Group endpoints instead of the individual SQL Server endpoints.

    Copy both **Listener Endpoint** values for later reference.

    ![Read/Write and Read-only listener endpoints are displayed.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/sqlfailovergroupendpoints.png "Read/Write and Read-only listener endpoints are displayed")

12. Go back to the **contososports** resource group blade.

13. Select the **contosokv** Key vault resource.

14. Under the **Settings** menu, select **Secrets**.

15. Locate and select the **ContosoSportsLeague** secret.

16. On the **Versions** screen, select **+ New Version**.
    
17. Copy the original connection string to the **ContosoSportsDB**, but replace the server name with the **Azure SQL Failover Group Read/Write Listener Endpoint** that was copied previously, then select **Create**.

    > **Note**: The connection string will need to be in the following format:
    > ```
    > Server=tcp:{failover_group_endpoint};Initial Catalog=ContosoSportsDB;Persist Security Info=False;User ID=demouser;Password=demo@pass123;MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;
    > ```

    ![The ContosoSportsLeague secret Versions screen is shown with a current and older version present in the list. ](media/newvalueforsecret_keyvault.png)

<!-- omit in toc -->
#### Subtask 3: Failover SQL Database Failover Group

>**Note**: This subtask is optional.

Since the Replication and Failover process can take anywhere from 10 to 30 minutes to complete, you have the choice to skip Subtask 3 and 4, and go directly to Task 3. However, if you have the time, it is recommended that you complete these steps.

1. In the Azure Portal, navigate back to the lab resource group.

2. From the list of resources, select the Primary SQL server resource.
    
    ![The list of lab resources is shown with the primary SQL server resource selected.](media/primary_sqlserverresource_inlist.png)

3. On the **SQL server** blade, select **Failover groups** under Settings.

    ![Failover groups option is highlighted.](images/2020-03-17-19-37-00.png "Failover groups option is highlighted")

4. Select the **Failover group** in the list.

    ![Failover group is highlighted in the list.](images/2020-03-17-19-38-01.png "Failover group is highlighted in the list")

5. On the Failover group blade, select the **Forced Failover** button, then select **Yes** to confirm the forced failover of the SQL Database Failover Group.

    ![Forced failover confirmation is displayed.](images/2020-03-17-19-39-56.png "Forced failover confirmation is displayed")

The failover may take a few minutes to complete. You can continue with the next Subtask.

<!-- omit in toc -->
#### Subtask 4: Test e-commerce Web App after Failover

1. From the Azure portal, select **Resource Groups**, and select **contososports**.

2. Select the **Web App** created earlier.

3. On the **App Service** blade, select **Overview**.

    ![Screenshot of Overview menu option.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image71.png "App Service blade")

4. On the **Overview** pane, select the **URL** for the Web App to open it in a new browser tab.

    ![On the App Service blade, in the Essentials section, the URL (http;//contososportsweb4azurewebsites.net) link is circled.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image72.png "App Service blade Essentials section")

5. After the e-commerce Web App loads in Internet Explorer, select **STORE** in the top navigation bar of the website.

    ![On the Contoso sports league website navigation bar, the Store button is circled.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image73.png "Contoso sports league website navigation bar")

6. Verify the product list from the database displays.

    ![Screenshot of the Contoso store webpage. Under Team Apparel, a Contoso hat, tank top, and hoodie display.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image74.png "Contoso store webpage")

### Task 3: Deploying the Call Center admin website

In this exercise, you will provision a website via the Azure Web App template using the Microsoft Azure Portal. You will then edit the necessary configuration files in the Starter Project and deploy the call center admin website.

<!-- omit in toc -->
#### Subtask 1: Provision the call center admin Web App

1. Using a new tab or instance of your browser, navigate to the Azure Management portal <http://portal.azure.com>.

2. Select **+ Create a resource** then select **Web**, then **Web App**.

3. Specify a **unique Name** for the Web App, **Resource Group** you have used throughout the lab are selected. Also, specify **.NET Core 3.1 (LTS)** as the **Runtime stack**.

    ![On the Web App blade, the App name field is set to contososportscallcentercp.](media/2019-03-28-05-29-59.png "Web App blade")

4. Select **Linux Plan**, and create a new Linux-based App Service Plan for the Web App.

5. After the values are accepted, select **Review and create**, then **Create**.  It will take a few minutes to provision.

<!-- omit in toc -->
#### Subtask 2: Update the configuration in the starter project

1. Navigate to the **App Service** blade for the Call Center Admin App just provisioned.

    ![The App Service blade displays.](media/2020-03-17-19-59-03.png "App Service blade")

2. On the **App Service** blade, select **Configuration** in the left pane.

    ![In the App Service blade, under Settings, select Configuration link.](media/2019-04-19-16-38-54.png "Configuration link")

3. Scroll down, and locate the **Connection strings** section.

4. Add a new **Connection String** with the following values, and select **OK**:

   - Name: **AppConfig**

   - Value: **Enter the Connection String for the App Configuration Store**.

   - Type: Select **Custom**.

    ![The Add/Edit connection string form is displayed and is populated with the preceding values.](media/image43.png)

5. Select the **OK** button.

6. Select the **Save** button.

    ![the Save button is circled on the App Service blade.](media/2019-03-28-05-36-38.png "App Service blade")

7. The call center web application resource needs access to the Key Vault. The App Configuration will use pass-through authentication to the Key Vault. To authenticate the application, it will utilize a system managed identity. From the left menu, select **Identity**.

8. With the **System assigned** tab selected, toggle the **Status** field to **On**, then select **Save**. 
    
    ![On the Identity screen, the System assigned tab is selected and the Status field is in the On position.](media/appconfig_systemidentity.png)

9. Open the **contosokv** Key Vault resource, and from the left menu, select **Access policies**. 

10. Select the **+ Add Access Policy** link.

11. In the **Add access policy** form, expand **Secret permissions** and check the box next to **Get** and **List**.  

12. In the **Select principal** blade, search for the name of the call center application you just created and choose the managed identity.

13. Select **Add**.
    
    ![The Add access policy form is displayed.](media/kv_addaccesspolicy_forconfig.png)

14. Select **Save** on the Access policies screen to commit the changes. 

<!-- omit in toc -->
#### Subtask 3: Configure and deploy the call center admin Web App from Visual Studio

1. Navigate to the **Contoso.Apps.SportsLeague.Admin** project located in the **Web** folder using the **Solution Explorer** in Visual Studio.

2. Right-click the **Contoso.Apps.SportsLeague.Admin** project, and select **Edit Project File**.

3. In the **PropertyGroup** element, add the following XML beneath the TargetFramework item and save the file:
   
    ```xml
    <UserSecretsId>79a3edd0-2092-40a2-a04d-dcb46d5ca9ed</UserSecretsId>
    ```

    ![A portion of the project file is displayed. The UserSecretsId element is highlighted in the code listing.](media/web_addusersecretsidtoproject.png)

4. Right-click the **Contoso.Apps.SportsLeague.Admin** project, and select **Manage NuGet Packages**.

5. Select the **Browse** tab, and search for **Microsoft.Azure.AppConfiguration.AspNetCore**.

6. Select **Microsoft.Azure.AppConfiguration.AspNetCore** from the search results, and in the next pane, select **Install** to install the latest stable version.

    ![The Nuget Package Manager windows is displayed with the Browse tab selected, Microsoft.Azure.AppConfiguration.AspNetCore entered into the search box and selected from the search results. In the next pane, the Install button is selected.](media/nuget_installappconfigpackage_web.png)

7. Repeat step 4-6, this time installing the latest **Azure.Identity**.

8. Now we are ready to configure this application to use the App Configuration in Azure. Under the **Contoso.Apps.SportsLeague.Web** project, open the **Program.cs** file.

9. Uncomment the following **using** statements at the top of the file:
    
    ```C#
    using Microsoft.Extensions.Configuration;
    using Azure.Identity;
    ```

10. In the **CreateHostBuilder** method, uncomment the following code - this tells the application to utilize the AppConfig connection string that you've already setup on the **contosoapp** application service to point to the centralized App Configuration resource.
    
    ```C#
    webBuilder.ConfigureAppConfiguration((hostingContext, config) =>
    {
        var settings = config.Build();

        config.AddAzureAppConfiguration(options =>
        {
            options.Connect(settings["ConnectionStrings:AppConfig"])
                    .ConfigureKeyVault(kv =>
                    {
                        kv.SetCredential(new DefaultAzureCredential());
                    });
        });
    })
    .UseStartup<Startup>();
    ```

11. Right-click the **Contoso.Apps.SportsLeague.Admin** project, and select **Publish**.

    ![In Solution Explorer, the right-click menu for Contoso.Apps.SportsLeague.Admin displays, and Publish is selected.](media/2019-04-19-14-30-03.png "Right-Click menu")

12. On the Publish dialog, select **Start**.

13. On the **Pick a publish target** dialog, select **App Service Linux** and in the right pane, choose **Select Existing**, then select **Create Profile**.

    ![The Pick a publish target window is shown with App Service Linux highlighted and Select Existing chosen. The Create Profile button is highlighted.](media/pickpublishtarget_linuxappservice.png)
   
14. Select the **Web App** that was created for the Call Center Admin Web App (with the name that was created previously).

    ![The App Service dialog is shown with the resource group expanded and the call center app service selected.](media/appsvcdeploy_selectcallcenterappdialog.png)
    
15. Select **OK**.

16. Select **Publish** to publish the Web application.

    ![Publish button is highlighted](media/2020-06-19-22-25-36.png "Publish button")

17. Once deployment is complete, navigate to the Web App. It should look like the following:

    ![The Contoso website displays the Contoso Sports League Admin webpage, which says that orders that display below are sorted by date, and you can select an order to see its details. However, at this time, there is no data available under Completed Orders.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image89.png "Contoso website")

    >**Note**: If you see a page that indicates the app service is running and asking about deploying code, refresh the browser window by selecting CTRL+F5.

### Task 4: Deploying the payment gateway

In this exercise, the attendee will provision an Azure API app template using the Microsoft Azure Portal. The attendee will then deploy the payment gateway API to the API app.

<!-- omit in toc -->
#### Subtask 1: Provision the payment gateway API app

1. Using a new tab or instance of your browser, navigate to the Azure Management Portal <http://portal.azure.com>.

2. Select **+ Create a resource**, type **API App** into the marketplace search box, and press **Enter**.  Select the **Create** button.

3. On the new **API App** blade, create the following values:

   - **App name:** Specify a unique name for the App Name.
   - **Subscription:** Your Azure subscription.
   - **Resource Group:** Select **Use existing** option, and choose the lab resource group.
   - **App Service Plan/Location** Select the **ContosoSportsPlan**.
   - **Application Insights:** **Disabled**

    ![On the API App blade. Configuration fields are displayed.](media/2019-04-20-14-55-42.png "Configuration fields are displayed")

4. After the values are accepted, select **Create**.  It will take a few minutes to provision.

<!-- omit in toc -->
#### Subtask 2: Deploy the Contoso.Apps.PaymentGateway project in Visual Studio

1. Navigate to the **Contoso.Apps.PaymentGateway** project located in the **APIs** folder using the **Solution Explorer** in Visual Studio.

2. Right-click the **Contoso.Apps.PaymentGateway** project, and select **Publish**.

    ![In Solution Explorer, Contoso.Apps.PaymentGateway is selected, and in its right-click menu, Publish is selected.](media/2019-04-19-14-52-22.png "Solution Explorer")

3. On the Publish dialog, select **Start** in the **Publish** section.

4. On the **Pick a publish target** dialog, ensure **App Service** is selected, and in the right pane, ensure the **Select Existing** option is selected, then choose **Create Profile**.

    ![The Pick a publish target dialog is displayed with App Service and Select existing selected.](media/pickpublishtargetappserviceexisting.png)

5. In the App Service dialog, expand the resource group, and select the API app service that you created for the payment gateway from the list, then choose **OK**.

    ![The App Service dialog is shown with the payment gateway api selected.](media/deployment_selectpaymentapiappservice.png)

6. Select **Publish** to publish the API App.

    ![Publish button is highlighted](media/2020-06-19-22-33-57.png "Publish button is highlighted")

7. In the Visual Studio **Output** view, you will see a status indicating the Web App was published successfully.

    ![The Visual Studio output shows that the web app was published successfully.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image99.png "Visual Studio output")

8. Copy and paste the gateway **URL** of the deployed **API App** into Notepad for later use.

9. Viewing the Web App in a browser will display the Swagger UI for the API.

   ![Payment Gateway is up and running and the Swagger UI is displayed.](media/2019-04-11-04-58-04.png "Swagger UI")

  > **Note**: When opening the Swagger UI using the Internet Explorer browser you will see a "Resolver error" error message. This is a result of the Swagger UI no longer supporting Internet Explorer. In another browser, the Swagger UI will work as expected.

### Task 5: Deploying the Offers Web API

In this exercise, the attendee will provision an Azure API app template using the Microsoft Azure Portal. The attendee will then deploy the Offers Web API.

<!-- omit in toc -->
#### Subtask 1: Provision the Offers Web API app

1. Using a new tab or instance of your browser, navigate to the Azure Management Portal (<http://portal.azure.com>).

2. Select **+ Create a resource**, type **API App** into the marketplace search box, and press **Enter**.  Select the **Create** button.

3. On the new **API App** blade, specify a unique name for the **API App**, and ensure the previously used Resource Group and the **ContosoSportsPlan** App Service Plan are selected. You may also disable **Application Insights**.

    ![In the API App blade, offersapith is typed in the App name field. App configuration fields displayed.](media/2019-04-11-05-03-33.png "API App blade")

4. After the values are accepted, select the **Create** button.

5. When the Web App template has completed provisioning, return to the resource group, then select the new API App from the list of resources.

<!-- omit in toc -->
#### Subtask 2: Configure Cross-Origin Resource Sharing (CORS)

1. On the **App Service** blade for the Offers API, under the **API** menu section, scroll down and select **CORS**.

    ![In the App Service blade, under API, CORS is selected.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image102.png "App Service blade")

2. In the **Allowed Origins** text box, specify `*` to allow all origins, and select **Save**.

    >**Note**: You should not normally do this in a production environment. In production, you should enter the specific domains as allowed origins you need to allow CORS access to the API. The wildcard (*) is used for this lab to make it easier just for this lab.

    ![CORS configuration blade displayed.  Entering * as the Allowed Origins value.](media/2019-03-28-08-20-57.png "CORS configuration blade")

<!-- omit in toc -->
#### Subtask 3: Update the configuration in the starter project

1. On the **App Service** blade for the Offers API, select **Configuration**.

    ![In the App Service blade, under Settings, select Configuration link.](media/2019-04-19-16-38-54.png "Configuration link")

2. Scroll down, and locate the **Connection strings** section.

3. Add a new **Connection String** with the following values, and select **OK**:

   - Name: **AppConfig**

   - Value: **Enter the Connection String for the App Configuration Store**.

   - Type: Select **Custom**.

    ![The Add/Edit connection string form is displayed and is populated with the preceding values.](media/image43.png)

4. Select the **Ok** button.

5. Select the **Save** button.

    ![the Save button is circled on the App Service blade.](media/2019-03-28-05-36-38.png "App Service blade")

6. The offers api resource needs access to the Key Vault. The App Configuration will use pass-through authentication to the Key Vault. To authenticate the application, it will utilize a system managed identity. From the left menu, select **Identity**.

7. With the **System assigned** tab selected, toggle the **Status** field to **On**, then select **Save**. 

    ![On the Identity screen, the System assigned tab is selected and the Status field is in the On position.](media/appconfig_systemidentity.png)

8. Open the **contosokv** Key Vault resource, and from the left menu, select **Access policies**. 

9. Select the **+ Add Access Policy** link.

10. In the **Add access policy** form, expand **Secret permissions** and check the box next to **Get** and **List**.  

11. In the **Select principal** blade, search for the name of the offers api application you just created and choose its managed identity.

12. Select **Add**.

    ![The Add access policy form is displayed.](media/kv_addaccesspolicy_forconfig.png)

13. Select **Save** on the Access policies screen to commit the changes.

<!-- omit in toc -->
#### Subtask 4: Deploy the Contoso.Apps.SportsLeague.Offers project in Visual Studio

1. Navigate to the **Contoso.Apps.SportsLeague.Offers** project located in the **APIs** folder using the **Solution Explorer** in Visual Studio.

2. Right-click the **Contoso.Apps.SportsLeague.Offers** project, and select **Edit Project File**.

3. In the **PropertyGroup** element, add the following XML beneath the TargetFramework item and save the file:

    ```xml
    <UserSecretsId>79a3edd0-2092-40a2-a04d-dcb46d5ca9ed</UserSecretsId>
    ```

    ![A portion of the project file is displayed. The UserSecretsId element is highlighted in the code listing.](media/web_addusersecretsidtoproject.png)

4. Right-click the **Contoso.Apps.SportsLeague.Offers** project, and select **Manage NuGet Packages**.

5. Select the **Browse** tab, and search for **Microsoft.Azure.AppConfiguration.AspNetCore**.

6. Select **Microsoft.Azure.AppConfiguration.AspNetCore** from the search results, and in the next pane, select **Install** to install the latest stable version.

    ![The Nuget Package Manager windows is displayed with the Browse tab selected, Microsoft.Azure.AppConfiguration.AspNetCore entered into the search box and selected from the search results. In the next pane, the Install button is selected.](media/nuget_installappconfigpackage_web.png)

7. Repeat step 4-6, this time installing the latest **Azure.Identity**.

8. Now we are ready to configure this application to use the App Configuration in Azure. Under the **Contoso.Apps.SportsLeague.Offers** project, open the **Program.cs** file.

9. Uncomment the following **using** statements at the top of the file:

    ```C#
    using Microsoft.Extensions.Configuration;
    using Azure.Identity;
    ```

10. In the **CreateHostBuilder** method, uncomment the following code - this tells the application to utilize the AppConfig connection string that you've already setup on the API application service to point to the centralized App Configuration resource.

    ```C#
    webBuilder.ConfigureAppConfiguration((hostingContext, config) =>
    {
        var settings = config.Build();

        config.AddAzureAppConfiguration(options =>
        {
            options.Connect(settings["ConnectionStrings:AppConfig"])
                    .ConfigureKeyVault(kv =>
                    {
                        kv.SetCredential(new DefaultAzureCredential());
                    });
        });
    })
    .UseStartup<Startup>();
    ```

11. Right-click the **Contoso.Apps.SportsLeague.Offers** project, and select **Publish**.

    ![In Solution Explorer, from the Contoso.Apps.SportsLeague.Admin right-click menu, Publish is selected.](media/2019-04-19-15-03-45.png "Solution Explorer")

12. On the Publish dialog, select **Start** in the **Publish** section.

13. On the **Pick a publish target** dialog, ensure **App Service** is selected, and in the right pane, ensure the **Select Existing** option is selected, then choose **Create Profile**.

    ![The Pick a publish target dialog is displayed with App Service and Select existing selected.](media/pickpublishtargetappserviceexisting.png)

14. In the App Service dialog, expand the resource group, and select the API app service that you created for the payment gateway from the list, then choose **OK**.

    ![The App Service dialog is shown with the offers api selected.](media/deployment_selectoffersapiservice.png)

15. Select **Publish** to publish the API App.

    ![Publish button is highlighted](media/2020-06-19-22-33-57.png "Publish button is highlighted")

16. In the Visual Studio **Output** view, you will see a status indicating the Web App was published successfully.

    ![The Visual Studio output shows that the web app was published successfully.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image99.png "Visual Studio output")

17. Copy and paste the gateway **URL** of the deployed **API App** into Notepad for later use.

18. Viewing the Web App in a browser will display the Swagger UI for the API.

19. In the Visual Studio **Output** view, you will see a status the API app was published successfully.

20. Record the value of the deployed API app URL into Notepad for later use.

21. Viewing the Web App in a browser will display the Swagger UI for the API.

    ![Payment Gateway is up and running and the Swagger UI is displayed.](media/2019-04-11-05-20-40.png "Swagger UI")

    > **Note**: When opening the Swagger UI using the Internet Explorer browser you will see a "Resolver error" error message. This is a result of the Swagger UI no longer supporting Internet Explorer. In another browser, the Swagger UI will work as expected.

22. Within the Swagger UI for the Offers API, select the `/api/get` method on the API. Then select the **Try it out** button, and then **Execute** to test out the API call from within the Swagger UI in the web browser. Once it executes, scroll down to view the results of the API call execution.

    ![Swagger UI displaying API call response.](media/2020-03-17-20-56-31.png "Swagger UI")

### Task 6: Add API endpoint configuration settings

<!-- omit in toc -->
#### Subtask 1: Add the API endpoint configuration settings

1. In the Azure Portal, return to the lab resource group.

2. Select the **contosoconfig** App Configuration resource from the list.

    ![The resource listing is displayed with the App Configuration resource highlighted.](media/appconfig_resourcelist_selection.png)

3. On the left menu, in the **Operations** section, select **Configuration explorer**.

4. Expand the **+ Create** button, and select **Key-value**. This API endpoint does not contain any secret values, thus is not required to be stored as a Key Vault value.

    ![The + Create button is expanded with the Key-value item selected.](media/appconfig_createkeyvaluemenu.png)

5. Create the new key-value entry with the following values:

   - Name: `APIEndpoints:PaymentsAPI`

   - Value: Enter the **HTTPS** URL for the Payments API App with `/api/nvp` appended to the end. This is the value that you recorded when deploying the API. Alternatively, this value can be retrieved by opening the API resource in the Azure Portal and copying the URL value on the Overview screen.

        >**Example**: `https://paymentsapi0.azurewebsites.net/api/nvp`

6. Create another Key-value setting with the following values:

   - App Setting Name: `APIEndpoints:OffersAPI`

   - Value: Enter the **HTTPS** URL for the Offers API App with `/api/get` appended to the end. This is the value that you recorded when deploying the API. Alternatively, this value can be retrieved by opening the API resource in the Azure Portal and copying the URL value on the Overview screen.

    >**Example**: `https://offersapi4.azurewebsites.net/api/get`

    >**Note**: Ensure both API URLs are using **SSL** (https://), or you will see a CORS errors.

    ![The list of Configuration settings is shown with the two new API endpoint settings highlighted.](media/appconfig_listofsettingswithAPIendpointshighlighted.png)

<!-- omit in toc -->
#### Subtask 2: Validate App Settings are correct

1. On the **App Service** blade, select **Overview**.

    ![Overview is selected on the left side of the App Service blade.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image119.png "App Service blade")

2. In the **Overview** pane, select the **URL** for the Web App to open it in a new browser tab.

    ![On the right side of the App Service overview screen, the URL (http://contososportsweb2101.azurewebsites.net) link is highlighted.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image120.png "App Service blade")

3. On the homepage, you should see the latest offers populated from the Offers API.

    ![On the Contoso Sports League webpage, Today\'s offers display: Baseball socks, Road bike, and baseball mitt.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image121.png "Contoso Sports League webpage")

4. Submit several test orders to ensure all pieces of the site are functional.  **Accept the default data during the payment processing.**

    ![On the Contoso Sports League webpage, the message Order Completed displays.](images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image122.png "Contoso Sports League webpage")

>**Leader Note**: If the attendee is still experiencing CORS errors, ensure the URLs to the Web App in Azure local host are exact.
